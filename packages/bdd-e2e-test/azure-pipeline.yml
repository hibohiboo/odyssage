trigger:
  branches:
    include:
      - develop
  paths:
    include:
      - apps/backend/**
      - apps/frontend/**
      - packages/bdd-e2e-test/**
      - packages/database/**
      - packages/schema/**

jobs:
  - job: bdd_test
    displayName: 'Run BDD E2E tests'
    pool:
      vmImage: 'ubuntu-latest'
    variables:
        dockerComposePath: /tmp/docker-compose
        DOCKER_BUILDKIT: 1  # BuildKitã‚’æœ‰åŠ¹åŒ–
        COMPOSE_DOCKER_CLI_BUILD: 1  # Docker CLIã®ãƒ“ãƒ«ãƒ‰æ”¹å–„

    services:
      postgres:
        image: postgres:17.4-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: main
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - checkout: self 
      # https://docs.docker.com/compose/install/linux/
      - bash: |
          sudo mkdir -p $(dockerComposePath)
          sudo curl -SL https://github.com/docker/compose/releases/download/v2.35.0/docker-compose-linux-x86_64 -o $(dockerComposePath)/docker-compose
          sudo chmod 755 $(dockerComposePath)/docker-compose
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ¤œè¨¼
          $(dockerComposePath)/docker-compose version
        displayName: Download docker-compose
        
      - script: |
          # Firebaseãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
          cd infra/local/firebase
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ 
          ls -la
          
          # docker-composeãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèª
          if [ ! -f "docker-compose.ci.yml" ]; then
            echo "##vso[task.logissue type=error]docker-compose.ci.yml ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # docker-composeã‚’ç›´æ¥ä½¿ç”¨ã—ã¦Firebaseã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’èµ·å‹•
          $(dockerComposePath)/docker-compose -f docker-compose.ci.yml up -d firebase
          
          # ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®èµ·å‹•ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®å¾…æ©Ÿãƒ­ã‚¸ãƒƒã‚¯
          echo "Waiting for Firebase Auth emulator..."
          MAX_RETRIES=20
          RETRY_COUNT=0
          RETRY_INTERVAL=2
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Attempt $RETRY_COUNT/$MAX_RETRIES"
            
            # Firebase Auth ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®çŠ¶æ…‹ç¢ºèª
            if curl -s http://localhost:9099/ > /dev/null; then
              echo "Firebase Auth emulator is ready"
              break
            fi
            
            # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¿½åŠ 
            docker ps
            docker logs $(docker ps -q --filter "name=firebase") 2>/dev/null || echo "Firebase container logs not available"
            
            # æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "##vso[task.logissue type=error]Firebase Auth emulator failed to start within timeout period"
              echo "##vso[task.complete result=Failed;]Firebase service is not available"
              exit 1
            fi
            
            sleep $RETRY_INTERVAL
          done
        displayName: 'Start Firebase Emulator with docker-compose'      # å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§æ—¢ã«Firebaseã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®å¾…æ©Ÿã‚’è¡Œã£ã¦ã„ã‚‹ãŸã‚ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤

      - task: UseNode@1
        inputs:
          version: '22.x'

      - script: |
          curl -fsSL https://bun.sh/install | bash
        displayName: 'Install Bun'

      - script: echo "##vso[task.setvariable variable=PATH]$(HOME)/.bun/bin:$(PATH)"
        displayName: 'Add Bun to PATH'

      - script: bun install
        displayName: 'Install Dependencies'

      - script: npx playwright install --with-deps chromium
        workingDirectory: apps/frontend
        displayName: 'download new browsers'

      - script: cp .dev.vars.ci .dev.vars
        workingDirectory: apps/backend
        displayName: 'Setting Backend env vars'

      - script: | 
          cp .env.ci .dev.local
        workingDirectory: apps/frontend
        displayName: 'Setting Frontend env vars'

      - script: |
          echo "127.0.0.1 db.localtest.me" | sudo tee -a /etc/hosts
        displayName: "Add db.localtest.me to /etc/hosts"
      
      - script: |
          echo "Waiting for PostgreSQL..."
          for i in {1..20}; do
            if PGPASSWORD=postgres psql -h db.localtest.me -U postgres -d main -c "SELECT 1" &>/dev/null; then
              echo "PostgreSQL is ready"
              break
            fi
            if [ $i -eq 20 ]; then
              echo "##vso[task.logissue type=error]PostgreSQL failed to start within timeout period"
              echo "##vso[task.complete result=Failed;]Database service is not available"
              exit 1
            fi
            echo "Attempt $i/20 - PostgreSQL not ready yet, waiting..."
            sleep 2
          done
          # æ¥ç¶šæƒ…å ±ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          PGPASSWORD=postgres psql -h db.localtest.me -U postgres -d main -c "\conninfo"
        displayName: 'Wait for PostgreSQL server to start'      # Neon Proxyã¯serviceã¨ã—ã¦èµ·å‹•ã™ã‚‹ã¨ postgresã®èµ·å‹•ã‚’å¾…ãŸãªã„ã®ã§ã€docker runã§èµ·å‹•ã™ã‚‹

      - script: |
          echo "Starting Neon Proxy..."
          # Dockerå†…ã‹ã‚‰ãƒ›ã‚¹ãƒˆã®PostgreSQLã«æ¥ç¶šã™ã‚‹ãŸã‚ã®è¨­å®š
          # --add-host=host.docker.internal:host-gateway ã¯ Linuxã§ host.docker.internal ã‚’ä½¿ã†ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
          docker run -d --name neon-proxy \
            -e PG_CONNECTION_STRING=postgres://postgres:postgres@host.docker.internal:5432/main \
            -p 4444:4444 \
            --add-host=host.docker.internal:host-gateway \
            ghcr.io/timowilhelm/local-neon-http-proxy:main
          
          # ãƒ—ãƒ­ã‚­ã‚·ãŒèµ·å‹•ã—ãŸã“ã¨ã‚’ç¢ºèª
          sleep 5
          docker ps | grep neon-proxy || { echo "##vso[task.logissue type=error]Neon Proxy failed to start"; exit 1; }
          
          # ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          docker logs neon-proxy
        displayName: 'Start Neon Proxy'

      - script: |
          bun run dev > backend.log 2>&1 &
          echo $! > ../backend.pid
        workingDirectory: apps/backend
        displayName: 'Start Backend'

      - script: |
          bun run preview:ci > frontend.log 2>&1 &
          echo $! > ../frontend.pid
        workingDirectory: apps/frontend
        displayName: 'Start Frontend'
      # ğŸ• Backend / Frontend ã®èµ·å‹•å¾…ã¡ï¼ˆé©å®œ curl ã§ãƒã‚§ãƒƒã‚¯ï¼‰
      - script: |
          echo "Waiting for frontend server..."
          for i in {1..30}; do
            if curl -s http://localhost:5173 > /dev/null; then
              echo "Frontend server is up."
              break
            fi
            if [ $i -eq 30 ]; then
              echo "##vso[task.logissue type=error]Frontend server failed to start within timeout period"
              echo "Frontend server logs:"
              cat apps/frontend/frontend.log
              echo "##vso[task.complete result=Failed;]Frontend server is not available"
              exit 1
            fi
            echo "Attempt $i/30 - Frontend server not ready yet, waiting..."
            sleep 2
          done

          echo "Waiting for backend server..."
          for i in {1..30}; do
            if curl -s http://localhost:8787 > /dev/null; then
              echo "Backend server is up."
              break
            fi
            if [ $i -eq 30 ]; then
              echo "##vso[task.logissue type=error]Backend server failed to start within timeout period"
              echo "Backend server logs:"
              cat apps/backend/backend.log
              echo "##vso[task.complete result=Failed;]Backend server is not available"
              exit 1
            fi
            echo "Attempt $i/30 - Backend server not ready yet, waiting..."
            sleep 2
          done
          
          # ã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          echo "Checking frontend server response:"
          curl -s -i http://localhost:5173 | head -10
          echo "Checking backend server response:"
          curl -s -i http://localhost:8787 | head -10
        displayName: 'Wait for servers to start'

      - script: bun run migrate:ci
        workingDirectory: packages/database
        displayName: 'Migration RDB'

      - script: bun run bdd-test
        workingDirectory: packages/bdd-e2e-test
        displayName: 'Run E2E Tests'
        env:
          CI: true

      - script: |
          kill $(cat backend.pid)
          kill $(cat frontend.pid)
          docker stop neon-proxy
          docker rm neon-proxy
        displayName: 'Cleanup Servers'
        workingDirectory: apps
        condition: always()

      - script: | 
          cp apps/frontend/.dev.local packages/bdd-e2e-test/output/.env.local
        condition: always()
        displayName: 'Output envfile frontend'      # E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã«ã®ã¿ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¨HTMLã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

      - task: PublishBuildArtifacts@1
        condition: failed()  # E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        inputs:
          pathToPublish: 'packages/bdd-e2e-test/output'
          artifactName: 'e2e-output'
        displayName: 'Upload screenshots as artifacts'

      # E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã«ã®ã¿ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - task: PublishBuildArtifacts@1
        condition: failed()  # E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        inputs:
          pathToPublish: 'apps/backend/backend.log'
          artifactName: 'backend-log'
        displayName: 'Upload backend logs as artifacts'

      # E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã«ã®ã¿ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - task: PublishBuildArtifacts@1
        condition: failed()  # E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        inputs:
          pathToPublish: 'apps/frontend/frontend.log'
          artifactName: 'frontend-log'
        displayName: 'Upload frontend logs as artifacts'
